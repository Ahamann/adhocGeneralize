
<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<script src="js/d3/d3.v3.min.js"></script>
<script src="js/leaflet/leaflet.js"></script>
<script src="js/d3/topojson.v0.min.js"></script>
<script src="js/jsts/javascript.util.js"></script>
<script src="js/jsts/jsts.js"></script>
<script type="text/javascript" src="js/requester.js"></script>
<script type="text/javascript" src="js/jquery/jquery-1.11.0.js"></script>


 <style>
  @import url(js/leaflet/leaflet.css);
  
  #map {
   width: 960px;
   height: 600px;
  }

#textarea {
   width: 960px;
   height: 600px;
  }

  path {
   fill: blue;
   fill-opacity: .2;
   stroke: #000;
   stroke-width: 1.5px;
  }
  path:hover {
   fill: green;
   fill-opacity: .7;
  }
/**
 * Popup
 */ 


.leaflet-popup-content
{
	margin: 0;
	
											
word-wrap: break-word;
height: 100px;
overflow : auto;
																	
					
}
.leaflet-div-icon {
	background: #fff;
	border: 1px solid #666;
	}
 </style>
</head>
<body>




<div id=map></div>
<div id=text>
<a href="https://github.com/Ahamann/adhocGeneralize/tree/master/master_alpha">https://github.com/Ahamann/adhocGeneralize/tree/master/master_alpha</a></div>
<div id=info><p>mode=0 - rtree call</p><p>mode=1 - selection</p><p>mode=2 - typification attempt</div>
<div id=alternative><a href="http://141.30.100.194:8080/master_alpha/full.html">alternative - without r-tree - full json</a></div>

<script type="text/javascript">

//base map
var map = L.map('map').setView([51, 0], 11)
var cloudmade = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
							attribution: 'bla',
							}).addTo(map);	
var baseLayers = {"base": cloudmade};	
L.control.layers(baseLayers).addTo(map);
var mapWidth = map.getSize().x
	mapHeigth = map.getSize().y
	menuHeight = 100;
map.on('dragend', dragMap);     //call function when draging map
map.on('zoomend', dragMap);		//call function when zooming map
L.control.scale().addTo(map);


var firstCall=true;
//json Layer
var jsonObject;
var jsonLayer;
var mode=getURLParam("mode");
if(mode=="")mode=0;
var zoom =  map.getZoom();



dragMap();











/* //first request to get json
requester.dataBaseRequest(mode, 4.9,  45.9, 5.3,  46.2, zoom, function(data) { 


	
		jsonObject = requester.getJSON(data);					
		//console.log("hm:" + jsonObject.name);

		var myStyle = {
			"fill": "blue",
		   "fill-opacity": ".2",
		   "stroke": "#000",
		   "stroke-width":  "1.5px",
			};												//overwritten by path (styles)
			
		jsonLayer = L.geoJson(jsonObject, {
			onEachFeature: function (feature, layer) {
		        //layer.bindPopup(feature.geometry.type);
				//layer.bindPopup(feature.properties.envelope);
				
				
				layer.bindPopup("<b>Coordinates:</b> " +feature.geometry.coordinates);
						

						
		      }
			//style: myStyle	
		}).addTo(map);
	//	var testLayers = {"test": jsonLayer};	
	//	L.control.layers(testLayers).addTo(map);
		var bounds = d3.geo.bounds(jsonObject);
		map.setView([bounds[0][1]+((bounds[1][1]-bounds[0][1])/2), bounds[0][0]+((bounds[1][0]-bounds[0][0])/2)],map.getZoom());

});  */




function dragMap(){
	
	//get map extent
	var bounds=map.getBounds();
	var minll=bounds.getSouthWest(); //minx,miny
	var maxll=bounds.getNorthEast(); //maxx, maxy
	
	//set min / max coordinates
	if(firstCall){
		var minx =4.9;
		var miny =45.9; 
		var maxx =5.3;
		var maxy =46.2; 
	} else{
		var minx =minll.lng;
		var miny =minll.lat; 
		var maxx =maxll.lng;
		var maxy =maxll.lat; 
	}
	
	//get PPI / DPI
	//get DPI / PPI for scale calculation
	var div = document.createElement("div");
	div.style.width="1in";
	var body = document.getElementsByTagName("body")[0];
	body.appendChild(div);
	var ppi = document.defaultView.getComputedStyle(div, null).getPropertyValue('width');
	ppi = parseFloat(ppi)
	body.removeChild(div);
	console.log("ppi/dpi="+ ppi);
	
	//calculate scale based in dpi and latitude
	//6378137.0 * 2 * Math.PI / 256 = 156543.034 //radius->tile size for zoom 0
	var tilesize=156543.034;
	var resolution= tilesize * Math.cos(maxll.lat-minll.lat) /  (Math.pow(2,map.getZoom()));
	var scale = ppi * 39.37 * resolution;
	console.log("scale = 1:"+scale);
	
	//call map request
	//zoom =  map.getZoom();
	updateMap(mode, minx, miny, maxx, maxy,scale);
	
	
	
	
	
	//temp
	var minMapLength = 0.001; //= 1mm
	var realLength = minMapLength * scale / 100000; //realcoords - 1,0 = 100km -> 1m = 0,00001
	var minArea = realLength * realLength;
	console.log(minArea);

}




function updateMap(mode, minx, miny, maxx, maxy, scale){
	requester.dataBaseRequest(mode, minx, miny, maxx, maxy, scale, function(data) { 
		jsonObject = requester.getJSON(data);					
		var myStyle = {
				"fill": "green",
			   "fill-opacity": ".2",
			   "stroke": "#000",
			   "stroke-width":  "2px",
				};	
		//delete old layer
		if(map.hasLayer(jsonLayer)){
			map.removeLayer(jsonLayer);
		}
		jsonLayer = L.geoJson(jsonObject, {
			onEachFeature: function (feature, layer) {
		        //layer.bindPopup(feature.geometry.type);
				layer.bindPopup("<b>Coordinates:</b> </br>" + feature.geometry.coordinates +"</br>"+(feature.properties.area));
				//layer.bindPopup(feature.properties.area);
		      }
			//style: myStyle	
		}).addTo(map);

		//setView for first call
		if(firstCall){
			var bounds = d3.geo.bounds(jsonObject);
			map.setView([bounds[0][1]+((bounds[1][1]-bounds[0][1])/2), bounds[0][0]+((bounds[1][0]-bounds[0][0])/2)],map.getZoom());
			firstCall = false;
		}
		
}); 
	
	
	
	
}

function getURLParam(name) {
	name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");

	var regexS = "[\\?&]" + name + "=([^&#]*)";
	var regex = new RegExp( regexS );
	var results = regex.exec( window.location.href );

	if ( results == null )
		return "";
	else
		return results[1];
}
	
</script>

</body>
</html>
