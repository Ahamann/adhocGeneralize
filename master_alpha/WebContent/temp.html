
<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<script src="js/d3/d3.v3.min.js"></script>
<script src="js/leaflet/leaflet.js"></script>
<script src="js/d3/topojson.v0.min.js"></script>
<script src="js/jsts/javascript.util.js"></script>
<script src="js/jsts/jsts.js"></script>
<script type="text/javascript" src="js/requester.js"></script>
<script type="text/javascript" src="js/jquery/jquery-1.11.0.js"></script>


 <style>
  @import url(js/leaflet/leaflet.css);
  
  #map {
   width: 960px;
   height: 600px;
  }

#textarea {
   width: 960px;
   height: 600px;
  }

  path {
   fill: blue;
   fill-opacity: .2;
   stroke: #000;
   stroke-width: 1.5px;
  }
  path:hover {
   fill: green;
   fill-opacity: .7;
  }

 </style>
</head>
<body>




<div id=map></div>



<script type="text/javascript">



//base map
var map = L.map('map').setView([51, 0], 11)
var cloudmade = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
							attribution: 'bla',
							}).addTo(map);	

var baseLayers = {"base": cloudmade};	
L.control.layers(baseLayers).addTo(map);

var mapWidth = map.getSize().x
	mapHeigth = map.getSize().y
	menuHeight = 100;


map.on('dragend', dragMap);
map.on('zoomend', dragMap);

//json Layer
var jsonObject;
var jsonLayer;

var mode=2;

//first request to get json
requester.dataBaseRequest(mode, function(data) { 
		jsonObject = requester.getJSON(data);					
		console.log("hm:" + jsonObject.name);

		var myStyle = {
			"fill": "blue",
		   "fill-opacity": ".2",
		   "stroke": "#000",
		   "stroke-width":  "1.5px",
			};												//overwritten by path (styles)

		jsonLayer = L.geoJson(jsonObject, {
			style: myStyle	
		}).addTo(map);
	//	var testLayers = {"test": jsonLayer};	
	//	L.control.layers(testLayers).addTo(map);
		var bounds = d3.geo.bounds(jsonObject);
		map.setView([bounds[0][1]+((bounds[1][1]-bounds[0][1])/2), bounds[0][0]+((bounds[1][0]-bounds[0][0])/2)],map.getZoom());

}); 




function dragMap(){
	var bounds=map.getBounds();
	var minll=bounds.getSouthWest(); //minx,miny
	var maxll=bounds.getNorthEast(); //maxx, maxy
	var msg=+minll.lng+','+minll.lat+','+maxll.lng+','+maxll.lat; //minX,minY,maxX,MaxY
	
	var minx =minll.lng;
	var miny =minll.lat; 
	var maxx =maxll.lng;
	var maxy =maxll.lat; 
	updateMap(3, minx, miny, maxx, maxy);
	//alert(msg);
}

function updateMap(mode, minx, miny, maxx, maxy){
	
	requester.dataBaseRequestUpdate(mode, minx, miny, maxx, maxy, function(data) { 
		jsonObject = requester.getJSON(data);					
		var myStyle = {
				"fill": "green",
			   "fill-opacity": ".2",
			   "stroke": "#000",
			   "stroke-width":  "2px",
				};	
		 map.removeLayer(jsonLayer);
		jsonLayer = L.geoJson(jsonObject, {
			style: myStyle	
		}).addTo(map);

		//var bounds = d3.geo.bounds(jsonObject);
		//map.setView([bounds[0][1]+((bounds[1][1]-bounds[0][1])/2), bounds[0][0]+((bounds[1][0]-bounds[0][0])/2)],map.getZoom());

}); 
	
	
	
	
}
	
</script>

</body>
</html>
